# Enhancements and Fixes

Date: 10-15-25

The following requests and fixes are proposed to improve the user experience and functionality of the application. Each item needs to be evaluated and designed thoroughly for implementation into the app. The implementation of each should then be planned.

## Notes

- Review @architecture.md for current architecture overview.

## Relevant Context

- Related PRD: `basic-to-advanced-transition-prd.md`
- Related Docs: `docs/architecture/valuation-rules.md`
- Related ADR: `ADR-basic-valuation.md`

## Bugs

### Valuation Rules

- On the /valuation-rules page in Advanced mode, after adding a new Ruleset or when there are no existing RuleGroups, the "Add RuleGroup" button in the RuleGroup pane does not function correctly. Clicking it opens the RuleSet creation modal rather than the RuleGroup creation modal. This needs to be fixed so that the correct modal is opened for adding a RuleGroup.
- Similar to above, when using the "Add Group" button, it does open the correct RuleGroup creation modal, but after creating the RuleGroup, the new RuleGroup does not appear in the RuleGroup list. No errors are noticed in the Frontend or Backend logs. This needs to be fixed so that newly created RuleGroups are displayed correctly.
- The Condition builder Dropdown for selecting a field should be vertically scrollable if the lists extends beyond the viewport height. Currently, if the list is too long, it extends beyond the bottom of the screen and the user cannot scroll down to see or select the remaining fields. This needs to be fixed to improve usability.

### Base to Advanced Rules

- When switching from Basic to Advanced rules in the Valuation Rules page, after running the newly developed Rule population, the behavior is still not as expected:
    - some baseline Rules still do not have their conditions and actions populated correctly. This needs to be fixed so that the Advanced mode correctly reflects the current state of the Baseline rules. Otherwise, the Baseline rules cannot be edited beyond the simple Overrides in Basic mode.
    - Due to the above, it seems that the Baseline rules without Actions/Conditions have no effect on Listing valuations. For example, all of the RamSpec Baseline Rules have no Conditions and 1 Action as `Fixed adjustment: $null`. But if I update a Rule manually, the Valuation seems to be applied correctly.
    - Baseline Rules which do have an Action seem to all have a type "Formula". These Formula-type Actions do not seem to be applied correctly, as no valuations are being calculated from this. For example, the CPU Mark (Single) Baseline Action is `Formula: usd â‰ˆ (cpu_mark_single/100)*5.2 with cohort guardrails`. However, none of the Listings are receiving any valuation adjustment from this Rule, even though all Listings have a cpu_mark_single value. This needs to be fixed so that Formula-type Actions are applied correctly.
        - We need to analyze how Formula-type Actions are being processed and calculated. Since they are created via raw text, it would be very easy to have a syntax error or other issue that prevents them from being calculated correctly. We need to ensure that the Formula text is parsed and evaluated correctly, and that any errors are logged for debugging. Ideally, this would be a UI wrapper for the Formula Engine, as described in detail below.
- Foreign Key Rules were intended to be hidden from the Advanced view in the recent implementation, however they are still visible. These should be hidden as they cannot be edited in Advanced mode and have no direct function. This needs to be fixed. For example, the 'RAM Spec' and 'Primary Storage Profile' Rules in the Listing RuleGroup.
- Part of the PRD for the Basic to Advanced Rules implementation was this section - "3. Missing Condition-to-Action Mapping", which was intended to handle the mapping of multiple Conditions to multiple Actions within a single Rule. This is not currently implemented, and needs to be designed and implemented. This is particularly important for the RamSpec Rules, where we need to be able to apply different multipliers based on the specific DDR generation (e.g., DDR3, DDR4, DDR5). For example, you might choose a base generation with a 1x multiplier (ie DDR4) for which you create your valuation, and then choose additional modifiers for other generations. This could utilize the existing Condition Multipliers system which currently defaults to Conditions Mappings. Instead, every Rule's Action could have 1 or more Multipliers, each of which could have:
    - a custom name (RAM Generation Multiplier, Condition Multiplier, etc)
    - 1 or more Conditions (eg DDR3, DDR4, DDR5) selected from a dropdown, using the same Dropdown as in the Conditions builder. This would require updating the "value" field from the Condition builder to select from a list of existing values for that field (if available), in addition to free text.
    - 1 multiplier value (eg 0.7, 1.0, 1.3) to each Condition value selected above.
    - For example, for the RamSpec RuleGroup, the Total Capacity (GB) Rule for RAM could have an Action providing a base Per Unit value for RAM. The Action would have an attached Condition for "DDR Generation" with 3 values selected (1 per generation) and then 3 Multipliers:
        - RAM Generation Multiplier
            - Condition: DDR3 -> Multiplier: 0.7
            - Condition: DDR4 -> Multiplier: 1.0
            - Condition: DDR5 -> Multiplier: 1.3
    - This "Action Conditions" system would be separate from the "Rule Conditions" system, but could utilize the same Condition builder UI components, + the multipliers system.

## Requests

### Formula Engine for Valuation Rules

- Due to issues encountered during the population of Baseline Rules from Base to Advanced, it has become apparent that Action Types of "Formula" may not be functional currently. There is an implementation of a FormulaEngine and relevant validation and parser in `formula.py`, but there is no indication in the UI whether these are operating correctly. Ideally, the formula Action type in the Rule Builder screen would function as an Advanced Action Builder; ie it would allow selecting a field from the given entity via dropdown, applying mathematical operations, and potentially referencing other fields or even other entities. This would then generate the appropriate formula text to be stored in the Action. This would greatly reduce the chance of syntax errors or other issues that could arise from manually entering formula text. Additionally, there should be validation to ensure that the generated formula is valid and can be evaluated correctly. This would likely require significant design and implementation effort, but would greatly enhance the usability and reliability of the Valuation Rules system.
